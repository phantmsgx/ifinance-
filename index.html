<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>iFinance Premium - Ultra Version</title>
    
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-title" content="iFinance">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800;900&display=swap" rel="stylesheet">
    
    <style>
        html, body { 
            touch-action: pan-x pan-y; 
            overscroll-behavior: none;
            font-family: 'Inter', sans-serif;
            background-color: #f8fafc;
            color: #0f172a;
            margin: 0;
            padding: 0;
            height: 100%;
            overflow-x: hidden;
            -webkit-font-smoothing: antialiased;
            transition: background-color 0.3s ease;
        }

        body { padding-bottom: 110px; -webkit-tap-highlight-color: transparent; }
        .hidden { display: none !important; }

        .tab-active { 
            color: #2563eb !important; 
            transform: scale(1.1); 
            transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }

        #desc { text-transform: uppercase; }

        * { user-select: none; -webkit-user-select: none; -webkit-touch-callout: none; }

        input, select, textarea { 
            user-select: auto !important; 
            -webkit-user-select: auto !important;
            font-size: 16px !important; 
        }

        .balance-text {
            font-size: clamp(1.4rem, 6vw, 2.2rem); 
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            line-height: 1.1;
            font-weight: 900;
            color: #0f172a;
        }
        
        .summary-text {
            font-size: clamp(0.9rem, 4vw, 1.3rem);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            font-weight: 800;
        }

        /* NOVO: Estilo para ocultar valores */
        .blur-val { filter: blur(10px); pointer-events: none; }

        @media (max-width: 640px) {
            .card-inner { padding: 1.25rem !important; border-radius: 30px; }
            .header-main { padding: 1rem !important; }
            .btn-action { padding: 1rem !important; }
            .input-main { padding: 1rem !important; font-size: 14px !important; }
            .nav-text { font-size: 8px !important; }
        }

        .bg-auth-gradient { background: radial-gradient(circle at top right, #eff6ff, #ffffff); }
        ::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

        .fade-in-up { animation: fadeInUp 0.6s cubic-bezier(0.23, 1, 0.32, 1); }
        @keyframes fadeInUp {
            from { opacity: 0; transform: translateY(30px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .premium-shadow { box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.08); }
        .card-inner { background: white; border: 1px solid #f1f5f9; border-radius: 40px; overflow: hidden; }
        button:active { transform: scale(0.96); }
        .btn-gradient { background: linear-gradient(135deg, #2563eb, #1d4ed8); }
        .anim-fade { animation: fadeIn 0.4s ease-out; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        
        .btn-income-quick {
            background: #f0fdf4;
            color: #16a34a;
            border: 1px solid #bbf7d0;
        }

        .btn-repeat {
            color: #cbd5e1;
            transition: all 0.2s;
        }
        .btn-repeat:hover { color: #2563eb; }

        .insight-card {
            border-left: 4px solid #2563eb;
        }

        /* Melhorias de Visual */
        .glass-nav {
            backdrop-filter: blur(10px);
            background: rgba(255, 255, 255, 0.8);
        }
        .transaction-item {
            transition: all 0.2s;
            border-radius: 20px;
        }
        .transaction-item:hover {
            background-color: #f1f5f9;
            transform: translateX(5px);
        }
        .dark-mode-toggle {
            cursor: pointer;
            transition: all 0.3s;
        }
    </style>
</head>
<body>

    <section id="auth-screen" class="min-h-screen flex flex-col items-center justify-center p-6 bg-auth-gradient text-center">
        <div class="mb-6 w-20 h-20 bg-blue-600 rounded-[30px] flex items-center justify-center shadow-2xl text-white text-4xl transform rotate-12">
            <i class="fa-solid fa-wallet"></i>
        </div>
        
        <h1 id="auth-title" class="text-3xl font-black mb-1 tracking-tighter">i<span class="text-blue-600">Finance</span></h1>
        <p id="auth-subtitle" class="text-slate-500 mb-8 font-medium text-sm">GestÃ£o de elite.</p>

        <div class="flex flex-col w-full max-w-md gap-3">
            <div class="relative">
                <i class="fa-solid fa-envelope absolute left-4 top-1/2 -translate-y-1/2 text-slate-300"></i>
                <input type="email" id="emailInput" placeholder="E-mail" class="w-full bg-white border-2 border-slate-50 p-4 pl-12 rounded-2xl font-bold outline-none shadow-sm focus:border-blue-200 transition-all">
            </div>
            <div class="relative">
                <i class="fa-solid fa-lock absolute left-4 top-1/2 -translate-y-1/2 text-slate-300"></i>
                <input type="password" id="passInput" placeholder="Senha" class="w-full bg-white border-2 border-slate-50 p-4 pl-12 rounded-2xl font-bold outline-none shadow-sm focus:border-blue-200 transition-all">
            </div>
            
            <div id="register-fields" class="hidden flex flex-col gap-3 fade-in-up">
                <div class="relative">
                    <i class="fa-solid fa-user absolute left-4 top-1/2 -translate-y-1/2 text-slate-300"></i>
                    <input type="text" id="userNameInput" placeholder="Nome Completo" class="w-full bg-white border-2 border-slate-50 p-4 pl-12 rounded-2xl font-bold outline-none shadow-sm">
                </div>
                <div class="relative">
                    <i class="fa-solid fa-coins absolute left-4 top-1/2 -translate-y-1/2 text-slate-300"></i>
                    <select id="userCurrencyInput" class="w-full bg-white border-2 border-slate-50 p-4 pl-12 rounded-2xl font-bold outline-none shadow-sm appearance-none">
                        <option value="BRL">ðŸ‡§ðŸ‡· BRL - Real Brasileiro</option>
                        <option value="USD">ðŸ‡ºðŸ‡¸ USD - DÃ³lar Americano</option>
                        <option value="EUR">ðŸ‡ªðŸ‡º EUR - Euro</option>
                        <option value="GBP">ðŸ‡¬ðŸ‡§ GBP - Libra Esterlina</option>
                        <option value="JPY">ðŸ‡¯ðŸ‡µ JPY - Iene JaponÃªs</option>
                    </select>
                    <i class="fa-solid fa-chevron-down absolute right-6 top-1/2 -translate-y-1/2 text-slate-400 pointer-events-none"></i>
                </div>
            </div>

            <button onclick="handleAuth()" id="btn-main-auth" class="btn-gradient text-white py-4 rounded-2xl font-black shadow-xl uppercase tracking-widest mt-2 hover:opacity-90 transition-all active:scale-95">Acessar Sistema</button>
            <button onclick="toggleAuthMode()" id="btn-switch-auth" class="text-blue-600 font-bold mt-2 text-[10px] uppercase tracking-wider">Ainda nÃ£o possui conta? Registre-se</button>
        </div>
    </section>

    <div id="main-app" class="hidden">
        <section id="tab-home" class="fade-in-up">
            <header class="header-main bg-white/80 backdrop-blur-xl border-b border-slate-100 p-5 sticky top-0 z-20 flex justify-between items-center px-6 md:px-10">
                <div>
                    <h1 class="text-xl font-black text-blue-600 italic tracking-tighter">iFinance</h1>
                    <p class="text-[7px] font-bold text-slate-400 uppercase tracking-[0.3em]">Premium Dashboard</p>
                </div>
                <div class="flex gap-3">
                    <button onclick="toggleGhostMode()" class="w-10 h-10 bg-slate-50 rounded-xl flex items-center justify-center text-slate-400 hover:bg-slate-100 transition-all">
                        <i id="ghost-icon" class="fa-solid fa-eye"></i>
                    </button>
                    <button onclick="logout()" class="w-10 h-10 bg-slate-50 rounded-xl flex items-center justify-center text-slate-400 hover:text-red-500 transition-all">
                        <i class="fa-solid fa-power-off text-base"></i>
                    </button>
                </div>
            </header>
            
            <main class="p-4 max-w-6xl mx-auto space-y-4">
                <!-- GrÃ¡fico de InteligÃªncia -->
                <div class="card-inner p-6 premium-shadow mb-4">
                    <h3 class="text-[9px] font-black text-slate-400 uppercase tracking-widest mb-4">Resumo Inteligente</h3>
                    <div class="h-[200px]">
                        <canvas id="mainChart"></canvas>
                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div class="card-inner p-6 border-blue-100 border-2 premium-shadow bg-gradient-to-br from-white to-blue-50/30">
                        <p class="text-[9px] font-black text-slate-400 uppercase tracking-widest mb-1">Saldo DisponÃ­vel</p>
                        <h2 class="balance-text" id="balance">0,00</h2>
                    </div>
                    <div class="card-inner p-6 premium-shadow">
                        <p class="text-[9px] font-black text-emerald-500 uppercase tracking-widest mb-1">Entradas</p>
                        <h2 class="summary-text text-emerald-600" id="incomes">0,00</h2>
                    </div>
                    <div class="card-inner p-6 premium-shadow">
                        <p class="text-[9px] font-black text-red-500 uppercase tracking-widest mb-1">SaÃ­das</p>
                        <h2 class="summary-text text-red-600" id="expenses">0,00</h2>
                    </div>
                </div>

                <button onclick="prepararRendaMensal()" class="w-full btn-income-quick p-4 rounded-[25px] flex items-center justify-center gap-3 font-black text-[10px] uppercase tracking-widest shadow-sm hover:bg-emerald-100 transition-all">
                    <i class="fa-solid fa-hand-holding-dollar text-lg"></i>
                    LanÃ§ar Renda do MÃªs
                </button>

                <div class="card-inner p-6 premium-shadow">
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-3">
                        <input type="text" id="desc" placeholder="DESCRIÃ‡ÃƒO (OPCIONAL)" class="input-main w-full bg-slate-50 p-4 rounded-xl font-black text-xs text-slate-700 outline-none focus:ring-2 focus:ring-blue-100 transition-all">
                        <input type="text" id="amountDisplay" placeholder="0,00" class="input-main w-full bg-slate-50 p-4 rounded-xl font-black text-lg text-center text-blue-600 outline-none focus:ring-2 focus:ring-blue-100 transition-all">
                        <select id="type" class="w-full bg-slate-50 p-4 rounded-xl font-black text-[10px] text-slate-500 uppercase appearance-none outline-none focus:ring-2 focus:ring-blue-100 transition-all">
                            <option value="expense">SaÃ­da (-)</option>
                            <option value="income">Entrada (+)</option>
                        </select>
                        <button onclick="addTransaction()" class="btn-action btn-gradient text-white font-black rounded-xl py-4 uppercase text-[10px] tracking-widest hover:opacity-90 transition-all shadow-lg active:scale-95">Confirmar</button>
                    </div>
                </div>

                <div class="card-inner p-6 premium-shadow">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="font-black text-[10px] uppercase tracking-widest">Extrato de TransaÃ§Ãµes</h3>
                        <div class="flex gap-2">
                            <select id="filterMonth" onchange="renderTransactions()" class="bg-slate-50 p-2 px-4 rounded-lg font-black text-[9px] outline-none border border-slate-100">
                                <option value="all">TODOS OS MESES</option>
                            </select>
                            <button onclick="exportData()" class="bg-slate-50 p-2 px-3 rounded-lg text-blue-600 hover:bg-blue-50 transition-all">
                                <i class="fa-solid fa-file-export"></i>
                            </button>
                        </div>
                    </div>

                    <ul id="transaction-list" class="divide-y divide-slate-50 space-y-1"></ul>
                </div>
            </main>
        </section>

        <!-- ABA DE CALCULADORA (ORIGINAL MANTIDA) -->
        <section id="tab-calc" class="hidden p-6 fade-in-up">
            <div class="max-w-md mx-auto card-inner p-8 premium-shadow text-center">
                <h2 class="text-xl font-black mb-6 uppercase tracking-tighter">Conversor de Moeda</h2>
                <div class="space-y-4">
                    <input type="text" id="calcValueDisplay" placeholder="0,00" class="w-full bg-slate-50 p-6 rounded-3xl font-black text-3xl text-center text-blue-600 outline-none">
                    <div class="grid grid-cols-2 gap-3">
                        <div class="bg-slate-50 p-4 rounded-2xl">
                            <p class="text-[8px] font-black text-slate-400 uppercase mb-1">De</p>
                            <select id="calcFrom" class="w-full bg-transparent font-bold outline-none"></select>
                        </div>
                        <div class="bg-slate-50 p-4 rounded-2xl">
                            <p class="text-[8px] font-black text-slate-400 uppercase mb-1">Para</p>
                            <select id="calcTo" class="w-full bg-transparent font-bold outline-none"></select>
                        </div>
                    </div>
                    <button onclick="lancarCambio()" class="w-full btn-gradient text-white py-4 rounded-2xl font-black uppercase tracking-widest shadow-lg mt-4">LanÃ§ar ConversÃ£o</button>
                </div>
            </div>
        </section>

        <!-- ABA DE CONFIGURAÃ‡Ã•ES -->
        <section id="tab-settings" class="hidden p-6 fade-in-up">
            <div class="max-w-md mx-auto space-y-4">
                <div class="card-inner p-6 premium-shadow">
                    <h3 class="text-xs font-black uppercase tracking-widest mb-4">Minha Conta</h3>
                    <div class="space-y-3">
                        <div class="flex justify-between items-center p-3 bg-slate-50 rounded-2xl">
                            <span class="text-xs font-bold text-slate-500">Nome</span>
                            <span id="display-name" class="text-xs font-black">UsuÃ¡rio</span>
                        </div>
                        <div class="flex justify-between items-center p-3 bg-slate-50 rounded-2xl">
                            <span class="text-xs font-bold text-slate-500">Moeda</span>
                            <span id="display-currency" class="text-xs font-black">BRL</span>
                        </div>
                    </div>
                </div>
                <div class="card-inner p-6 premium-shadow">
                    <h3 class="text-xs font-black uppercase tracking-widest mb-4 text-red-500">Zona de Perigo</h3>
                    <button onclick="limparTudo()" class="w-full p-4 bg-red-50 text-red-600 rounded-2xl font-black text-[10px] uppercase tracking-widest hover:bg-red-100 transition-all">
                        Apagar Todos os Dados
                    </button>
                </div>
            </div>
        </section>

        <!-- NavegaÃ§Ã£o Inferior (ORIGINAL MANTIDA E MELHORADA) -->
        <nav class="fixed bottom-0 left-0 right-0 glass-nav border-t border-slate-100 p-4 flex justify-around items-center z-30">
            <button onclick="switchTab('home')" id="nav-home" class="flex flex-col items-center gap-1 tab-active">
                <i class="fa-solid fa-house-chimney text-xl"></i>
                <span class="nav-text text-[9px] font-black uppercase tracking-tighter">InÃ­cio</span>
            </button>
            <button onclick="switchTab('calc')" id="nav-calc" class="flex flex-col items-center gap-1 text-slate-300">
                <i class="fa-solid fa-calculator text-xl"></i>
                <span class="nav-text text-[9px] font-black uppercase tracking-tighter">CÃ¢mbio</span>
            </button>
            <button onclick="switchTab('settings')" id="nav-settings" class="flex flex-col items-center gap-1 text-slate-300">
                <i class="fa-solid fa-circle-user text-xl"></i>
                <span class="nav-text text-[9px] font-black uppercase tracking-tighter">Perfil</span>
            </button>
        </nav>
    </div>

    <script>
        // ESTADO GLOBAL
        let currentUser = null;
        let isRegisterMode = false;
        let isGhostMode = false;
        let mainChart = null;
        const USERS_DB = 'ifinance_users_secure_v1';

        // LÃ“GICA DE INPUT MONETÃRIO (MANTIDA DO ORIGINAL)
        const rawValues = { amountDisplay: 0, calcValueDisplay: 0 };
        
        function setupMask(id) {
            const el = document.getElementById(id);
            el.addEventListener('input', (e) => {
                let val = e.target.value.replace(/\D/g, '');
                rawValues[id] = parseInt(val || 0) / 100;
                e.target.value = formatCurrency(rawValues[id]);
            });
            el.value = formatCurrency(0);
        }

        // LÃ“GICA DE PROTEÃ‡ÃƒO E LOGIN (REFEITA PARA SER INTELIGENTE)
        function toggleAuthMode() {
            isRegisterMode = !isRegisterMode;
            document.getElementById('register-fields').classList.toggle('hidden');
            document.getElementById('btn-main-auth').innerText = isRegisterMode ? 'CRIAR CONTA PREMIUM' : 'ACESSAR SISTEMA';
            document.getElementById('btn-switch-auth').innerText = isRegisterMode ? 'JÃ POSSUI CONTA? ACESSAR' : 'AINDA NÃƒO POSSUI CONTA? REGISTRE-SE';
        }

        function handleAuth() {
            const email = document.getElementById('emailInput').value.trim().toLowerCase();
            const pass = document.getElementById('passInput').value.trim();

            if (!email || !pass) return toast('Preencha os campos!', 'error');

            let users = JSON.parse(localStorage.getItem(USERS_DB) || '[]');

            if (isRegisterMode) {
                const name = document.getElementById('userNameInput').value.trim();
                const currency = document.getElementById('userCurrencyInput').value;

                if (!name) return toast('Qual o seu nome?', 'error');
                if (users.find(u => u.email === email)) return toast('E-mail jÃ¡ cadastrado!', 'error');

                const newUser = {
                    email, pass, name, currency,
                    transactions: [],
                    createdAt: new Date().toISOString()
                };

                users.push(newUser);
                localStorage.setItem(USERS_DB, JSON.stringify(users));
                toast('Bem-vindo ao iFinance!', 'success');
                login(newUser);
            } else {
                const user = users.find(u => u.email === email && u.pass === pass);
                if (user) {
                    login(user);
                } else {
                    toast('E-mail ou senha incorretos!', 'error');
                }
            }
        }

        function login(user) {
            currentUser = user;
            sessionStorage.setItem('ifinance_active_session', user.email);
            
            document.getElementById('auth-screen').classList.add('hidden');
            document.getElementById('main-app').classList.remove('hidden');
            
            // Atualiza Perfil
            document.getElementById('display-name').innerText = user.name;
            document.getElementById('display-currency').innerText = user.currency;
            document.getElementById('user-greeting').innerText = `OlÃ¡, ${user.name.split(' ')[0]}`;

            initDashboard();
        }

        function checkSession() {
            const sessionEmail = sessionStorage.getItem('ifinance_active_session');
            if (sessionEmail) {
                const users = JSON.parse(localStorage.getItem(USERS_DB) || '[]');
                const user = users.find(u => u.email === sessionEmail);
                if (user) login(user);
            }
        }

        function logout() {
            sessionStorage.removeItem('ifinance_active_session');
            location.reload();
        }

        // DASHBOARD INTELIGENTE
        function initDashboard() {
            setupMask('amountDisplay');
            setupMask('calcValueDisplay');
            populateCurrencySelectors();
            populateMonthFilter();
            renderTransactions();
            initChart();
        }

        function addTransaction() {
            const val = rawValues.amountDisplay;
            if (val <= 0) return toast('Informe um valor!', 'warning');

            const desc = document.getElementById('desc').value.trim() || 'LANÃ‡AMENTO SEM NOME';
            const type = document.getElementById('type').value;

            const transaction = {
                id: Date.now(),
                text: desc,
                amount: type === 'expense' ? -val : val,
                date: new Date().toLocaleDateString('pt-BR'),
                monthYear: new Date().toLocaleDateString('pt-BR', { month: '2-digit', year: 'numeric' })
            };

            currentUser.transactions.unshift(transaction);
            save();
            
            // Limpa inputs
            document.getElementById('desc').value = '';
            rawValues.amountDisplay = 0;
            document.getElementById('amountDisplay').value = formatCurrency(0);

            populateMonthFilter();
            renderTransactions();
            updateChart();
            toast('LanÃ§amento realizado!', 'success');
        }

        function renderTransactions() {
            const list = document.getElementById('transaction-list');
            const filter = document.getElementById('filterMonth').value;
            
            let filtered = currentUser.transactions;
            if (filter !== 'all') {
                filtered = filtered.filter(t => t.monthYear === filter);
            }

            list.innerHTML = '';
            
            filtered.forEach(t => {
                const isExpense = t.amount < 0;
                const li = document.createElement('li');
                li.className = 'transaction-item flex items-center justify-between p-4 bg-white mb-1';
                li.innerHTML = `
                    <div class="flex items-center gap-4">
                        <div class="w-10 h-10 rounded-xl flex items-center justify-center ${isExpense ? 'bg-red-50 text-red-500' : 'bg-emerald-50 text-emerald-500'}">
                            <i class="fa-solid ${isExpense ? 'fa-arrow-down' : 'fa-arrow-up'}"></i>
                        </div>
                        <div>
                            <p class="text-[11px] font-black uppercase leading-tight">${t.text}</p>
                            <p class="text-[8px] font-bold text-slate-400 uppercase tracking-widest">${t.date}</p>
                        </div>
                    </div>
                    <div class="flex items-center gap-3">
                        <span class="text-xs font-black ${isExpense ? 'text-red-600' : 'text-emerald-600'} ${isGhostMode ? 'blur-val' : ''}">
                            ${formatCurrency(t.amount)}
                        </span>
                        <button onclick="deleteTx(${t.id})" class="text-slate-200 hover:text-red-400 transition-all">
                            <i class="fa-solid fa-trash-can text-[10px]"></i>
                        </button>
                    </div>
                `;
                list.appendChild(li);
            });

            updateSummary(filtered);
        }

        function deleteTx(id) {
            Swal.fire({
                title: 'Excluir?',
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#2563eb',
                cancelButtonColor: '#f1f5f9',
                confirmButtonText: 'Sim',
                cancelButtonText: 'NÃ£o'
            }).then((result) => {
                if (result.isConfirmed) {
                    currentUser.transactions = currentUser.transactions.filter(t => t.id !== id);
                    save();
                    renderTransactions();
                    updateChart();
                }
            });
        }

        function updateSummary(txs) {
            const inc = txs.filter(t => t.amount > 0).reduce((a, b) => a + b.amount, 0);
            const exp = txs.filter(t => t.amount < 0).reduce((a, b) => a + Math.abs(b.amount), 0);
            const bal = inc - exp;

            document.getElementById('balance').innerText = formatCurrency(bal);
            document.getElementById('incomes').innerText = formatCurrency(inc);
            document.getElementById('expenses').innerText = formatCurrency(exp);

            // Efeito visual no saldo
            const balEl = document.getElementById('balance');
            balEl.classList.toggle('text-red-600', bal < 0);
            balEl.classList.toggle('text-slate-900', bal >= 0);
            
            if (isGhostMode) {
                balEl.classList.add('blur-val');
                document.getElementById('incomes').classList.add('blur-val');
                document.getElementById('expenses').classList.add('blur-val');
            } else {
                balEl.classList.remove('blur-val');
                document.getElementById('incomes').classList.remove('blur-val');
                document.getElementById('expenses').classList.remove('blur-val');
            }
        }

        // GRÃFICO INTELIGENTE (CHART.JS)
        function initChart() {
            const ctx = document.getElementById('mainChart').getContext('2d');
            mainChart = new Chart(ctx, {
                type: 'line',
                data: getChartData(),
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: {
                        y: { display: false },
                        x: { grid: { display: false }, ticks: { font: { size: 8, weight: 'bold' } } }
                    },
                    elements: { point: { radius: 0 } }
                }
            });
        }

        function updateChart() {
            if (mainChart) {
                mainChart.data = getChartData();
                mainChart.update();
            }
        }

        function getChartData() {
            const months = [];
            for (let i = 5; i >= 0; i--) {
                const d = new Date();
                d.setMonth(d.getMonth() - i);
                months.push(d.toLocaleDateString('pt-BR', { month: '2-digit', year: 'numeric' }));
            }

            const data = months.map(m => {
                return currentUser.transactions
                    .filter(t => t.monthYear === m)
                    .reduce((a, b) => a + b.amount, 0);
            });

            return {
                labels: months.map(m => m.split('/')[0]),
                datasets: [{
                    data: data,
                    borderColor: '#2563eb',
                    borderWidth: 3,
                    tension: 0.4,
                    fill: true,
                    backgroundColor: 'rgba(37, 99, 235, 0.05)'
                }]
            };
        }

        // UTILITÃRIOS
        function formatCurrency(val) {
            return new Intl.NumberFormat('pt-BR', {
                style: 'currency',
                currency: currentUser ? currentUser.currency : 'BRL'
            }).format(val);
        }

        function save() {
            let users = JSON.parse(localStorage.getItem(USERS_DB) || '[]');
            const idx = users.findIndex(u => u.email === currentUser.email);
            if (idx !== -1) {
                users[idx] = currentUser;
                localStorage.setItem(USERS_DB, JSON.stringify(users));
            }
        }

        function switchTab(tab) {
            ['home', 'calc', 'settings'].forEach(t => {
                document.getElementById(`tab-${t}`).classList.add('hidden');
                document.getElementById(`nav-${t}`).classList.remove('tab-active');
                document.getElementById(`nav-${t}`).classList.add('text-slate-300');
            });
            document.getElementById(`tab-${tab}`).classList.remove('hidden');
            document.getElementById(`nav-${tab}`).classList.add('tab-active');
            document.getElementById(`nav-${tab}`).classList.remove('text-slate-300');
        }

        function toggleGhostMode() {
            isGhostMode = !isGhostMode;
            document.getElementById('ghost-icon').className = isGhostMode ? 'fa-solid fa-eye-slash' : 'fa-solid fa-eye';
            renderTransactions();
        }

        function toast(text, icon) {
            Swal.fire({
                text: text,
                icon: icon,
                toast: true,
                position: 'top',
                showConfirmButton: false,
                timer: 3000,
                timerProgressBar: true,
                customClass: { popup: 'rounded-2xl font-bold' }
            });
        }

        function populateMonthFilter() {
            const select = document.getElementById('filterMonth');
            const months = [...new Set(currentUser.transactions.map(t => t.monthYear))];
            const current = select.value;
            select.innerHTML = '<option value="all">TODOS OS MESES</option>';
            months.sort().reverse().forEach(m => {
                const opt = document.createElement('option');
                opt.value = m;
                opt.innerText = m;
                select.appendChild(opt);
            });
            select.value = current;
        }

        function populateCurrencySelectors() {
            const currencies = ['BRL', 'USD', 'EUR', 'GBP', 'JPY'];
            const from = document.getElementById('calcFrom');
            const to = document.getElementById('calcTo');
            from.innerHTML = ''; to.innerHTML = '';
            currencies.forEach(c => {
                from.innerHTML += `<option value="${c}">${c}</option>`;
                to.innerHTML += `<option value="${c}">${c}</option>`;
            });
            from.value = currentUser.currency;
            to.value = 'USD';
        }

        function exportData() {
            const data = JSON.stringify(currentUser.transactions, null, 2);
            const blob = new Blob([data], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `ifinance_backup_${new Date().toLocaleDateString()}.json`;
            a.click();
            toast('Backup gerado!', 'success');
        }

        function limparTudo() {
            Swal.fire({
                title: 'Apagar tudo?',
                text: 'Seus dados serÃ£o perdidos permanentemente.',
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#ef4444',
                confirmButtonText: 'Sim, apagar',
                cancelButtonText: 'Cancelar'
            }).then((result) => {
                if (result.isConfirmed) {
                    currentUser.transactions = [];
                    save();
                    renderTransactions();
                    updateChart();
                    toast('Dados apagados!', 'success');
                }
            });
        }

        function prepararRendaMensal() {
            Swal.fire({
                title: 'LanÃ§ar Renda Mensal',
                input: 'number',
                inputLabel: 'Valor do seu salÃ¡rio/renda',
                inputPlaceholder: '0.00',
                showCancelButton: true,
                confirmButtonText: 'LanÃ§ar',
                cancelButtonText: 'Cancelar'
            }).then((result) => {
                if (result.value) {
                    const val = parseFloat(result.value);
                    currentUser.transactions.unshift({
                        id: Date.now(),
                        text: 'RENDA MENSAL',
                        amount: val,
                        date: new Date().toLocaleDateString('pt-BR'),
                        monthYear: new Date().toLocaleDateString('pt-BR', { month: '2-digit', year: 'numeric' })
                    });
                    save();
                    renderTransactions();
                    updateChart();
                    toast('Renda lanÃ§ada!', 'success');
                }
            });
        }

        function lancarCambio() {
            const val = rawValues.calcValueDisplay;
            if (val <= 0) return toast('Informe um valor!', 'warning');
            const from = document.getElementById('calcFrom').value;
            const to = document.getElementById('calcTo').value;
            
            // SimulaÃ§Ã£o de cÃ¢mbio inteligente
            toast(`ConversÃ£o de ${from} para ${to} lanÃ§ada!`, 'success');
            
            currentUser.transactions.unshift({
                id: Date.now(),
                text: `CÃ‚MBIO: ${from} > ${to}`,
                amount: -val,
                date: new Date().toLocaleDateString('pt-BR'),
                monthYear: new Date().toLocaleDateString('pt-BR', { month: '2-digit', year: 'numeric' })
            });
            save();
            renderTransactions();
            updateChart();
            switchTab('home');
        }

        // Inicia o sistema
        window.onload = () => {
            checkSession();
        };
    </script>
</body>
</html>
